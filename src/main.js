// arquivo database local
// import database from "./db.json" assert { type: "json" };

const database = {
      "valor": 3.99,
      "produto": "Batata Inglesa",
      "loja": "SUPER LAGOA",
      "id": 133
    },
    {
      "valor": 3.99,
      "produto": "Banana Prata",
      "loja": "SUPER LAGOA",
      "id": 134
    },
    {
      "valor": 4.29,
      "produto": "Cebola",
      "loja": "SUPER LAGOA",
      "id": 135
    },
    {
      "valor": 4.49,
      "produto": "Tomate Comum",
      "loja": "SUPER LAGOA",
      "id": 136
    },
    {
      "valor": 1.89,
      "produto": "Limão Taiti",
      "loja": "SUPER LAGOA",
      "id": 137
    },
    {
      "valor": 1.89,
      "produto": "Macaxeira",
      "loja": "SUPER LAGOA",
      "id": 138
    },
    {
      "valor": 1.99,
      "produto": "Laranja Pera",
      "loja": "SUPER LAGOA",
      "id": 139
    },
    {
      "valor": 2.49,
      "produto": "Melão Espanhol",
      "loja": "SUPER LAGOA",
      "id": 140
    },
    {
      "valor": 2.49,
      "produto": "Melão Japonês",
      "loja": "SUPER LAGOA",
      "id": 141
    },
    {
      "valor": 2.49,
      "produto": "Melão Gália",
      "loja": "SUPER LAGOA",
      "id": 142
    },
    {
      "valor": 3.29,
      "produto": "Abacate",
      "loja": "SUPER LAGOA",
      "id": 143
    },
    {
      "valor": 3.29,    {
      "valor": 3.99,
      "produto": "Batata Inglesa",
      "loja": "SUPER LAGOA",
      "id": 133
    },
    {
      "valor": 3.99,
      "produto": "Banana Prata",
      "loja": "SUPER LAGOA",
      "id": 134
    },
    {
      "valor": 4.29,
      "produto": "Cebola",
      "loja": "SUPER LAGOA",
      "id": 135
    },
    {
      "valor": 4.49,
      "produto": "Tomate Comum",
      "loja": "SUPER LAGOA",
      "id": 136
    },
    {
      "valor": 1.89,
      "produto": "Limão Taiti",
      "loja": "SUPER LAGOA",
      "id": 137
    },
    {
      "valor": 1.89,
      "produto": "Macaxeira",
      "loja": "SUPER LAGOA",
      "id": 138
    },
    {
      "valor": 1.99,
      "produto": "Laranja Pera",
      "loja": "SUPER LAGOA",
      "id": 139
    },
    {
      "valor": 2.49,
      "produto": "Melão Espanhol",
      "loja": "SUPER LAGOA",
      "id": 140
    },
    {
      "valor": 2.49,
      "produto": "Melão Japonês",
      "loja": "SUPER LAGOA",
      "id": 141
    },
    {
      "valor": 2.49,
      "produto": "Melão Gália",
      "loja": "SUPER LAGOA",
      "id": 142
    },
    {
      "valor": 3.29,
      "produto": "Abacate",
      "loja": "SUPER LAGOA",
      "id": 143
    },
    {
      "valor": 3.29,
      "produto": "Batata Doce",
      "loja": "SUPER LAGOA",
      "id": 144
    },
    {
      "valor": 3.49,
      "produto": "Mamão Formosa",
      "loja": "SUPER LAGOA",
      "id": 145
    },
    {
      "valor": 3.49,
      "produto": "Manga Tommy",
      "loja": "SUPER LAGOA",
      "id": 146
    },
    {
      "valor": 3.99,
      "produto": "Acerola 500g",
      "loja": "SUPER LAGOA",
      "id": 147
    },
    {
      "valor": 3.99,
      "produto": "Batata Doce",
      "loja": "SUPER LAGOA",
      "id": 148
    },
    {
      "valor": 7.99,
      "produto": "Uva Vitótia 500g",
      "loja": "SUPER LAGOA",
      "id": 149
    },
    {
      "valor": 7.99,
      "produto": "Maracujá",
      "loja": "SUPER LAGOA",
      "id": 150
    },
    {
      "valor": 4.99,
      "produto": "Repolho Verde",
      "loja": "SUPER LAGOA",
      "id": 151
    },
    {
      "valor": 14.99,
      "produto": "Ovo Extra Branco c/20",
      "loja": "SUPER LAGOA",
      "id": 152
    },
    {
      "valor": 2.29,
      "produto": "Mamão Formosa",
      "loja": "SUPER PORTUGAL",
      "id": 153
    },
    {
      "valor": 4.19,
      "produto": "Batata Inglesa",
      "loja": "SUPER PORTUGAL",
      "id": 154
    },
    {
      "valor": 3.49,
      "produto": "Goiaba",
      "loja": "SUPER PORTUGAL",
      "id": 155
    },
    {
      "valor": 2.99,
      "produto": "Melão Japonês",
      "loja": "SUPER PORTUGAL",
      "id": 156
    },
    {
      "valor": 2.29,
      "produto": "Laranja Pera",
      "loja": "SUPER PORTUGAL",
      "id": 157
    },
    {
      "valor": 1.69,
      "produto": "Melancia",
      "loja": "SUPER PORTUGAL",
      "id": 158
    },
    {
      "valor": 2.99,
      "produto": "Beterraba",
      "loja": "SUPER PORTUGAL",
      "id": 159
    },
    {
      "valor": 4.79,
      "produto": "Cebola",
      "loja": "SUPER PORTUGAL",
      "id": 160
    },
    {
      "valor": 2.99,
      "produto": "Batata Doce",
      "loja": "SUPER PORTUGAL",
      "id": 161
    },
    {
      "valor": 6.69,
      "produto": "Cenoura",
      "loja": "SUPER PORTUGAL",
      "id": 162
    },
    {
      "valor": 2.99,
      "produto": "Acerola 500g",
      "loja": "SUPER PORTUGAL",
      "id": 163
    },
    {
      "valor": 2.79,
      "produto": "Mamão Formosa",
      "loja": "UNI REDE",
      "id": 164
    },
    {
      "valor": 3.29,
      "produto": "Goiaba",
      "loja": "UNI REDE",
      "id": 165
    },
    {
      "valor": 4.69,
      "produto": "Batata Inglesa",
      "loja": "UNI REDE",
      "id": 166
    },
    {
      "valor": 4.79,
      "produto": "Cebola",
      "loja": "UNI REDE",
      "id": 167
    },
    {
      "valor": 19.9,
      "produto": "Alho",
      "loja": "UNI REDE",
      "id": 168
    },
    {
      "valor": 2.39,
      "produto": "Laranja Pera",
      "loja": "UNI REDE",
      "id": 169
    },
    {
      "valor": 2.99,
      "produto": "Batata Doce",
      "loja": "UNI REDE",
      "id": 170
    },
    {
      "valor": 3.39,
      "produto": "Abacate",
      "loja": "UNI REDE",
      "id": 171
    },
    {
      "valor": 5.49,
      "produto": "Pimentão Verde",
      "loja": "UNI REDE",
      "id": 172
    },
    {
      "valor": 5.89,
      "produto": "Tomate Comum",
      "loja": "UNI REDE",
      "id": 173
    }
  ]
}
      "produto": "Batata Doce",
      "loja": "SUPER LAGOA",
      "id": 144
    },
    {
      "valor": 3.49,
      "produto": "Mamão Formosa",
      "loja": "SUPER LAGOA",
      "id": 145
    },
    {
      "valor": 3.49,
      "produto": "Manga Tommy",
      "loja": "SUPER LAGOA",
      "id": 146
    },
    {
      "valor": 3.99,
      "produto": "Acerola 500g",
      "loja": "SUPER LAGOA",
      "id": 147
    },
    {
      "valor": 3.99,
      "produto": "Batata Doce",
      "loja": "SUPER LAGOA",
      "id": 148
    },
    {
      "valor": 7.99,
      "produto": "Uva Vitótia 500g",
      "loja": "SUPER LAGOA",
      "id": 149
    },
    {
      "valor": 7.99,
      "produto": "Maracujá",
      "loja": "SUPER LAGOA",
      "id": 150
    },
    {
      "valor": 4.99,
      "produto": "Repolho Verde",
      "loja": "SUPER LAGOA",
      "id": 151
    },
    {
      "valor": 14.99,
      "produto": "Ovo Extra Branco c/20",
      "loja": "SUPER LAGOA",
      "id": 152
    },
    {
      "valor": 2.29,
      "produto": "Mamão Formosa",
      "loja": "SUPER PORTUGAL",
      "id": 153
    },
    {
      "valor": 4.19,
      "produto": "Batata Inglesa",
      "loja": "SUPER PORTUGAL",
      "id": 154
    },
    {
      "valor": 3.49,
      "produto": "Goiaba",
      "loja": "SUPER PORTUGAL",
      "id": 155
    },
    {
      "valor": 2.99,
      "produto": "Melão Japonês",
      "loja": "SUPER PORTUGAL",
      "id": 156
    },
    {
      "valor": 2.29,
      "produto": "Laranja Pera",
      "loja": "SUPER PORTUGAL",
      "id": 157
    },
    {
      "valor": 1.69,
      "produto": "Melancia",
      "loja": "SUPER PORTUGAL",
      "id": 158
    },
    {
      "valor": 2.99,
      "produto": "Beterraba",
      "loja": "SUPER PORTUGAL",
      "id": 159
    },
    {
      "valor": 4.79,
      "produto": "Cebola",
      "loja": "SUPER PORTUGAL",
      "id": 160
    },
    {
      "valor": 2.99,
      "produto": "Batata Doce",
      "loja": "SUPER PORTUGAL",
      "id": 161
    },
    {
      "valor": 6.69,
      "produto": "Cenoura",
      "loja": "SUPER PORTUGAL",
      "id": 162
    },
    {
      "valor": 2.99,
      "produto": "Acerola 500g",
      "loja": "SUPER PORTUGAL",
      "id": 163
    },
    {
      "valor": 2.79,
      "produto": "Mamão Formosa",
      "loja": "UNI REDE",
      "id": 164
    },
    {
      "valor": 3.29,
      "produto": "Goiaba",
      "loja": "UNI REDE",
      "id": 165
    },
    {
      "valor": 4.69,
      "produto": "Batata Inglesa",
      "loja": "UNI REDE",
      "id": 166
    },
    {
      "valor": 4.79,
      "produto": "Cebola",
      "loja": "UNI REDE",
      "id": 167
    },
    {
      "valor": 19.9,
      "produto": "Alho",
      "loja": "UNI REDE",
      "id": 168
    },
    {
      "valor": 2.39,
      "produto": "Laranja Pera",
      "loja": "UNI REDE",
      "id": 169
    },
    {
      "valor": 2.99,
      "produto": "Batata Doce",
      "loja": "UNI REDE",
      "id": 170
    },
    {
      "valor": 3.39,
      "produto": "Abacate",
      "loja": "UNI REDE",
      "id": 171
    },
    {
      "valor": 5.49,
      "produto": "Pimentão Verde",
      "loja": "UNI REDE",
      "id": 172
    },
    {
      "valor": 5.89,
      "produto": "Tomate Comum",
      "loja": "UNI REDE",
      "id": 173
    }
  ]
}

const getFinalMarketList = (initialMarketList) => {
  // remove a prop id que não utilizamos
  const handledList = initialMarketList.map((item) => {
    delete item.id;
    return item;
  });

  // agrupa a lista por produto - retorna um objeto
  const groupedObjectByProduct = groupByProduct(handledList);

  // classifica a lista por preço dentro de cada grupo de produto - retorna um array
  const groupedRankedList = Object.entries(groupedObjectByProduct).map(
    ([key, value]) => rankAscendingList(value)
  );

  // desagrupa a lista após a classificação
  const rankedList = groupedRankedList.flat(1);

  // remove os itens com classificação acima de 3º lugar
  const cleanedRankedList = rankedList.filter((item) => item.rank < 4);

  // agrupa os itens por loja
  const groupedObjectByShop = groupByShop(cleanedRankedList);

  // gera a lista final para exibição na tela
  const finalMarketList = generateFinalListHTML(groupedObjectByShop);

  return finalMarketList;
};

const generateFinalListHTML = (obj) => {
  let strFinalList = "";
  Object.entries(sortAscendingObjectByKey(obj)).map(([key, value]) => {
    strFinalList = strFinalList.concat(
      `
      <div id="card">
        <table class="table">
          <thead>
            <tr class="table-header-row">
              <td class="table-header-data">${key.toUpperCase()}</td>
            </tr>
          </thead>
          <tbody>
      `
    );

    sortAscendingListByProduct(value).forEach((item) => {
      strFinalList = strFinalList.concat(
        `
        <tr class="table-row rank-${item.rank}">
          <td class="table-data rank-${item.rank}">${item.rank}º</td>
          <td class="table-data produto">${item.produto}</td>
          <td class="table-data tag-${item.rank}">
            ${
              item.rank === 1
                ? '<span class="material-icons">emoji_events</span>'
                : ""
            }
          </td>
          <td class="table-data valor">${item.valor.toLocaleString("pt-br", {
            style: "decimal",
            minimumFractionDigits: 2,
          })}</td>
        </tr>
        `
      );
    });

    strFinalList = strFinalList.concat(
      `
          </tbody>
        </table>
      </div>
      `
    );
  });

  return strFinalList;
};

const groupByShop = (arr) => {
  return arr.reduce((result, currentValue) => {
    (result[currentValue.loja] = result[currentValue.loja] || []).push(
      currentValue
    );
    return result;
  }, {});
};

const groupByProduct = (arr) => {
  return arr.reduce((result, currentValue) => {
    (result[currentValue.produto] = result[currentValue.produto] || []).push(
      currentValue
    );
    return result;
  }, {});
};

const sortAscendingListByPrice = (arr) =>
  arr.sort((itemA, itemB) => itemA.valor - itemB.valor);

const sortAscendingListByProduct = (arr) =>
  arr.sort((itemA, itemB) => {
    const productA = itemA.produto.toUpperCase();
    const productB = itemB.produto.toUpperCase();
    if (productA < productB) {
      return -1;
    }
    if (productA > productB) {
      return 1;
    }

    return 0;
  });

const sortAscendingObjectByKey = (obj) =>
  Object.entries(obj)
    .sort()
    .reduce((o, [k, v]) => ((o[k] = v), o), {});

const rankAscendingList = (arr) => {
  let rank = 1;
  return sortAscendingListByPrice(arr).map((item, index) => {
    if (index > 0 && item.valor > arr[index - 1].valor) {
      rank++;
    }
    item.rank = rank;
    return item;
  });
};

const checkbox = document.getElementById("checkbox");

const changeTheme = () => {
  document.body.classList.toggle("dark");
};

const loadTheme = () => {
  const isDarkMode = localStorage.getItem("dark");

  if (isDarkMode) {
    changeTheme();
  }
};

loadTheme();

checkbox.addEventListener("change", () => {
  changeTheme();

  //salva ou remove o dark mode]
  localStorage.removeItem("dark");

  if (document.body.classList.contains("dark")) {
    localStorage.setItem("dark", 1);
  }
});

$("#data").html(database.data);

// utilizando api
// let url =
//   "https://api.sheety.co/d3a0bd0987cadf495617032c2aa34290/marketList/list";
// fetch(url)
//   .then((response) => response.json())
//   .then((response) => {
//     $("#json").html(getFinalMarketList(response.list));
//   });

// utilizando arquivo local db.json
$("#lista").html(getFinalMarketList(database.lista));
